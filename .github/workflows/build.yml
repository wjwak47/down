name: Build Mac x64

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Download yt-dlp for macOS
        run: |
          mkdir -p resources/bin-mac
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o resources/bin-mac/yt-dlp
          chmod +x resources/bin-mac/yt-dlp

      - name: Download ffmpeg for macOS
        run: |
          curl -L https://evermeet.cx/ffmpeg/getrelease/zip -o ffmpeg.zip
          unzip ffmpeg.zip -d resources/bin-mac/
          chmod +x resources/bin-mac/ffmpeg

      - name: Download hashcat for macOS
        run: |
          mkdir -p resources/hashcat-mac
          brew install hashcat
          HASHCAT_PATH=$(which hashcat)
          cp "$HASHCAT_PATH" resources/hashcat-mac/hashcat
          chmod +x resources/hashcat-mac/hashcat
          HASHCAT_SHARE=$(brew --prefix hashcat)/share/hashcat
          if [ -d "$HASHCAT_SHARE" ]; then
            cp -r "$HASHCAT_SHARE"/* resources/hashcat-mac/
          fi

      - name: Download John the Ripper for macOS
        run: |
          mkdir -p resources/john-mac/run
          brew install john-jumbo
          JOHN_PREFIX=$(brew --prefix john-jumbo)
          if [ -f "$JOHN_PREFIX/share/john/zip2john" ]; then
            cp "$JOHN_PREFIX/share/john/zip2john" resources/john-mac/run/
            cp "$JOHN_PREFIX/share/john/rar2john" resources/john-mac/run/ 2>/dev/null || true
          elif [ -f "$JOHN_PREFIX/bin/zip2john" ]; then
            cp "$JOHN_PREFIX/bin/zip2john" resources/john-mac/run/
            cp "$JOHN_PREFIX/bin/rar2john" resources/john-mac/run/ 2>/dev/null || true
          fi
          curl -L https://raw.githubusercontent.com/philsmd/7z2hashcat/master/7z2hashcat.pl -o resources/john-mac/run/7z2hashcat.pl 2>/dev/null || true
          chmod +x resources/john-mac/run/* 2>/dev/null || true

      - name: Install dependencies
        run: npm ci

      - name: Package for macOS x64
        run: npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Mac x64 DMG
        uses: actions/upload-artifact@v4
        with:
          name: ProFlow-Studio-Mac-x64
          path: dist/*.dmg
          retention-days: 30
