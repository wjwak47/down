# 电脑唤醒后状态同步修复方案

## 问题描述

用户长时间离开电脑，电脑进入休眠状态。唤醒后发现：
- 控制台显示密码破解仍在进行
- 前端界面重置为初始状态
- 前后端状态不同步

## 根本原因

1. **Electron渲染进程暂停**：系统休眠时渲染进程被暂停
2. **IPC事件监听器丢失**：唤醒后事件监听器可能需要重新注册
3. **React状态重置**：组件状态在某些情况下会被重置
4. **会话检测时机**：只在应用启动时检测，不在唤醒时检测

## ✅ 解决方案 - 已实施

### 1. ✅ 添加唤醒检测机制

已在 `FileCompressor.jsx` 中实现：
- `checkAndRestoreSession()` 函数：增强的会话恢复逻辑
- 多重唤醒检测：`focus`、`visibilitychange`、`pageshow` 事件
- 自动切换到crack模式并恢复运行中的会话
- 智能区分运行中和暂停的会话

### 2. ✅ 增强IPC事件监听器恢复

已实现 `registerCrackListeners()` 函数：
- 在窗口获得焦点时自动重新注册IPC监听器
- 防止监听器丢失导致的状态不同步
- 清理旧监听器避免重复注册

### 3. ✅ 添加状态恢复机制

已实现完整的状态恢复：
- 自动恢复 `crackJobId` 和 `crackSessionId`
- 恢复破解进度和统计信息
- 自动添加文件到破解列表
- 显示用户友好的重连提示

### 4. ✅ 多层唤醒检测

实现了三种唤醒检测方法：
- **Window Focus**: 窗口获得焦点时检测
- **Visibility Change**: 页面从隐藏变为可见时检测  
- **Page Show**: 页面从缓存恢复时检测

## 🔧 技术实现详情

### 核心函数

```javascript
// 增强的会话恢复函数
const checkAndRestoreSession = async () => {
    // 检测运行中的会话并自动恢复
    // 显示暂停会话的恢复对话框
    // 重新注册IPC监听器
}

// IPC监听器重新注册
const registerCrackListeners = () => {
    // 清理旧监听器
    // 重新注册所有crack相关事件
    // 确保状态同步正常
}
```

### 事件监听器

```javascript
window.addEventListener('focus', handleFocus);
document.addEventListener('visibilitychange', handleVisibilityChange);
window.addEventListener('pageshow', handlePageShow);
```

## 🎯 用户体验改进

### 自动恢复场景
1. **运行中会话**：自动切换到crack模式，显示"重新连接中..."
2. **暂停会话**：显示会话恢复对话框，用户可选择恢复或删除
3. **成功提示**：显示"🔄 Reconnected to running password crack session"

### 防错机制
- 防止重复注册IPC监听器
- 智能延迟确保后端准备就绪
- 错误处理和用户友好的错误提示

## 📋 测试验证

### 测试场景
1. ✅ 电脑休眠后唤醒
2. ✅ 应用最小化后恢复
3. ✅ 切换到其他应用后返回
4. ✅ 浏览器标签页切换

### 预期行为
- 运行中的密码破解会话自动恢复显示
- 进度条和统计信息正确同步
- IPC事件正常接收和处理
- 用户可以正常暂停/恢复/停止操作

## 🚀 立即解决方法（用户指南）

### 如果遇到状态不同步：

1. **切换到Crack标签**
   - 应该会自动检测并恢复会话
   - 如果有运行中的会话会自动显示

2. **查看恢复对话框**
   - 如果弹出会话对话框，点击"Resume"
   - 可以选择删除不需要的旧会话

3. **手动刷新（最后手段）**
   - 如果自动恢复失败，可以重启应用
   - 应用启动时会自动检测未完成的会话

## ✅ 修复状态

- **状态**: 🟢 已完成
- **测试**: ✅ 通过
- **部署**: ✅ 已实施
- **文档**: ✅ 已更新

这个修复确保用户在电脑休眠/唤醒后能够无缝恢复密码破解会话，提供了多重保障机制和用户友好的体验。