# åƒµå°¸ä¼šè¯æ¸…ç†ä¿®å¤ - è§£å†³é‡å¯åè‡ªåŠ¨æ¢å¤æ—§ç ´è§£æ–‡ä»¶é—®é¢˜

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šé‡æ–°æ‰“å¼€è½¯ä»¶æ—¶ï¼ˆ`npm run dev`ï¼‰ï¼Œåº”ç”¨ç›´æ¥æ˜¾ç¤ºæ—§çš„ç ´è§£æ–‡ä»¶é¡µé¢ï¼Œè€Œä¸æ˜¯å¹²å‡€çš„æ–‡ä»¶å‹ç¼©å™¨ç•Œé¢ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

1. **ä¼šè¯æŒä¹…åŒ–æœºåˆ¶**: åº”ç”¨ä½¿ç”¨SessionManagerå°†ç ´è§£ä»»åŠ¡çš„çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶
2. **çŠ¶æ€æœªæ­£ç¡®æ›´æ–°**: å½“ç”¨æˆ·åœæ­¢ä»»åŠ¡æˆ–åº”ç”¨å´©æºƒæ—¶ï¼Œä¼šè¯çŠ¶æ€å¯èƒ½ä»ç„¶æ˜¯ `running` æˆ– `paused`
3. **è‡ªåŠ¨æ¢å¤é€»è¾‘**: åº”ç”¨å¯åŠ¨æ—¶ä¼šæ£€æŸ¥æ‰€æœ‰ `running` çŠ¶æ€çš„ä¼šè¯å¹¶è‡ªåŠ¨æ¢å¤
4. **åƒµå°¸ä¼šè¯**: è¿™äº›æ®‹ç•™çš„ `running` çŠ¶æ€ä¼šè¯æˆä¸º"åƒµå°¸ä¼šè¯"ï¼Œå¯¼è‡´ä¸å¿…è¦çš„è‡ªåŠ¨æ¢å¤

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿›åœæ­¢ä»»åŠ¡æ—¶çš„ä¼šè¯æ¸…ç†

**ä¿®æ”¹æ–‡ä»¶**: `src/main/modules/fileCompressor/index.js`

```javascript
// åœ¨ cleanupSession å‡½æ•°ä¸­
async function cleanupSession(session, id) {
    // å…ˆå°†ä¼šè¯çŠ¶æ€æ ‡è®°ä¸ºå·²å®Œæˆï¼Œé˜²æ­¢è‡ªåŠ¨æ¢å¤
    if (session.sessionId) {
        console.log('[Crack] Marking session as stopped...');
        sessionManager.completeSession(session.sessionId, false); // false = stopped/failed
        
        // ç„¶ååˆ é™¤ä¼šè¯æ–‡ä»¶
        sessionManager.deleteSession(session.sessionId);
    }
    // ... å…¶ä»–æ¸…ç†é€»è¾‘
}
```

### 2. æ·»åŠ åƒµå°¸ä¼šè¯æ¸…ç†åŠŸèƒ½

**ä¿®æ”¹æ–‡ä»¶**: `src/main/modules/fileCompressor/sessionManager.js`

```javascript
/**
 * æ¸…ç†åƒµå°¸ä¼šè¯ï¼ˆå¯åŠ¨æ—¶æ¸…ç†å¯èƒ½æ®‹ç•™çš„è¿è¡Œä¸­ä¼šè¯ï¼‰
 */
cleanupZombieSessions() {
    // å°†æ‰€æœ‰ running/paused çŠ¶æ€çš„ä¼šè¯æ ‡è®°ä¸º failed
    // å› ä¸ºåº”ç”¨é‡å¯æ„å‘³ç€ä¹‹å‰çš„è¿›ç¨‹å·²ç»ˆæ­¢
    for (const sessionFile of sessionFiles) {
        if (sessionData.status === 'running' || sessionData.status === 'paused') {
            sessionData.status = 'failed';
            sessionData.endTime = Date.now();
            // å†™å›æ–‡ä»¶
            fs.writeFileSync(sessionFile, JSON.stringify(sessionData, null, 2));
        }
    }
}
```

### 3. å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†

**ä¿®æ”¹æ–‡ä»¶**: `src/main/modules/fileCompressor/index.js`

```javascript
const sessionManager = new SessionManager();

// å¯åŠ¨æ—¶æ¸…ç†åƒµå°¸ä¼šè¯
console.log('[Init] Cleaning up zombie sessions...');
sessionManager.cleanupZombieSessions();
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜
- âŒ é‡å¯åº”ç”¨åè‡ªåŠ¨æ˜¾ç¤ºæ—§çš„ç ´è§£æ–‡ä»¶é¡µé¢
- âŒ ç”¨æˆ·éœ€è¦æ‰‹åŠ¨åˆ‡æ¢å›å…¶ä»–æ¨¡å¼
- âŒ æ§åˆ¶å°å¯èƒ½æ˜¾ç¤ºè¿æ¥å¤±è´¥çš„é”™è¯¯
- âŒ ç”¨æˆ·ä½“éªŒä¸ä½³

### ä¿®å¤åçš„æ•ˆæœ
- âœ… åº”ç”¨å¯åŠ¨æ—¶æ˜¾ç¤ºå¹²å‡€çš„æ–‡ä»¶å‹ç¼©å™¨ç•Œé¢
- âœ… åƒµå°¸ä¼šè¯è¢«è‡ªåŠ¨æ¸…ç†ï¼ŒçŠ¶æ€æ›´æ–°ä¸º `failed`
- âœ… åªæœ‰çœŸæ­£è¿è¡Œä¸­çš„ä¼šè¯æ‰ä¼šè¢«æ¢å¤
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸å¼€å§‹æ–°çš„æ“ä½œ

## æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ
```
ğŸ§ª Testing Zombie Session Cleanup Fix
âœ… Test 1 PASSED: Zombie session cleanup method implemented
âœ… Test 2 PASSED: Startup cleanup call implemented  
âœ… Test 3 PASSED: Improved session cleanup implemented
âœ… Test 4 PASSED: Auto-restore logic preserved
```

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤
1. å¯åŠ¨ä¸€ä¸ªç ´è§£ä»»åŠ¡
2. å¼ºåˆ¶é€€å‡ºåº”ç”¨ï¼ˆCtrl+C æˆ–å…³é—­ç»ˆç«¯ï¼‰
3. é‡æ–°è¿è¡Œ `npm run dev`
4. éªŒè¯åº”ç”¨æ˜¾ç¤ºå¹²å‡€çš„æ–‡ä»¶å‹ç¼©å™¨ç•Œé¢
5. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æ˜¾ç¤º "Cleaning up zombie sessions" æ¶ˆæ¯

## æŠ€æœ¯ç»†èŠ‚

### ä¼šè¯çŠ¶æ€æµè½¬
```
å¯åŠ¨ç ´è§£ä»»åŠ¡ â†’ running
ç”¨æˆ·åœæ­¢ä»»åŠ¡ â†’ completed (æ­£å¸¸)
åº”ç”¨å´©æºƒ/å¼ºåˆ¶é€€å‡º â†’ running (åƒµå°¸çŠ¶æ€)
åº”ç”¨é‡å¯ â†’ failed (æ¸…ç†å)
```

### æ¸…ç†æ—¶æœº
1. **åº”ç”¨å¯åŠ¨æ—¶**: è‡ªåŠ¨æ¸…ç†æ‰€æœ‰åƒµå°¸ä¼šè¯
2. **åœæ­¢ä»»åŠ¡æ—¶**: æ­£ç¡®æ ‡è®°ä¼šè¯çŠ¶æ€ä¸ºå·²å®Œæˆ
3. **å®šæœŸæ¸…ç†**: åˆ é™¤è¶…è¿‡30å¤©çš„å·²å®Œæˆä¼šè¯

### ä¿ç•™çš„åŠŸèƒ½
- âœ… æ­£å¸¸çš„ä¼šè¯æ¢å¤åŠŸèƒ½ï¼ˆå¦‚æœæœ‰çœŸæ­£è¿è¡Œä¸­çš„ä»»åŠ¡ï¼‰
- âœ… æš‚åœ/æ¢å¤åŠŸèƒ½
- âœ… ä¼šè¯å†å²è®°å½•
- âœ… è¿›åº¦ä¿å­˜å’Œæ¢å¤

## ç›¸å…³æ–‡ä»¶

- `src/main/modules/fileCompressor/index.js` - ä¸»è¦çš„åœæ­¢å’Œæ¸…ç†é€»è¾‘
- `src/main/modules/fileCompressor/sessionManager.js` - ä¼šè¯ç®¡ç†å’Œåƒµå°¸æ¸…ç†
- `src/renderer/src/pages/FileCompressor.jsx` - å‰ç«¯è‡ªåŠ¨æ¢å¤é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
- `test-zombie-session-cleanup.js` - æµ‹è¯•éªŒè¯è„šæœ¬

## ç»“è®º

è¿™ä¸ªä¿®å¤è§£å†³äº†ç”¨æˆ·é‡å¯åº”ç”¨åè‡ªåŠ¨æ˜¾ç¤ºæ—§ç ´è§£æ–‡ä»¶çš„é—®é¢˜ã€‚ç°åœ¨åº”ç”¨ä¼šï¼š

1. **å¯åŠ¨æ—¶æ¸…ç†åƒµå°¸ä¼šè¯** - å°†æ®‹ç•™çš„è¿è¡Œä¸­ä¼šè¯æ ‡è®°ä¸ºå¤±è´¥
2. **æ­£ç¡®å¤„ç†åœæ­¢æ“ä½œ** - ç¡®ä¿ä¼šè¯çŠ¶æ€è¢«æ­£ç¡®æ›´æ–°
3. **ä¿æŒå¹²å‡€çš„å¯åŠ¨çŠ¶æ€** - ç”¨æˆ·çœ‹åˆ°çš„æ˜¯å¹²å‡€çš„ç•Œé¢ï¼Œè€Œä¸æ˜¯æ—§çš„ä»»åŠ¡

ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨åº”ç”¨ï¼Œä¸ä¼šå†é‡åˆ°é‡å¯åè‡ªåŠ¨æ¢å¤æ—§æ–‡ä»¶çš„é—®é¢˜ã€‚